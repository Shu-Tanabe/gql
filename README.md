## GQL tutorial

https://www.apollographql.com/tutorials/fullstack-quickstart

## 機能

1. 今後のロケット発射予定を全てフェッチする
1. 特定の発射予定を ID で指定してフェッチする
1. 特定のユーザーとしてログインする
1. ユーザーがログインしている場合に宇宙旅行を予約する
1. ユーザーがログインしている場合に宇宙旅行をキャンセルする

## 基本的な処理の流れ

1. クライアントサイドからクエリ、またはミューテーションなどのオペレーションがリクエストされる
1. クライアントサイドからのリクエストを受け取った GraphQL サーバはまず、スキーマの中にリクエストされたオペレーションがあることを確認する
1. 確認できたらスキーマに対応するリゾルバを実行する
1. 実行されるリゾルバは引数である args や context の内容をチェックし、context として受け取ったデータソースへアクセスする処理を実行する
1. リゾルバは処理された内容を（場合によっては加工して）クライアントサイドへ返す

## 機能ごとの処理の流れ

### 今後のロケット発射予定を全てフェッチする

1. リクエストを受け取ったリゾルバは Query.launches を実行する
1. context を通じて受け取ったデータソースの launchAPI の getAllLaunches メソッドにより、今後のロケット発射予定が全てフェッチされる
1. 取得したロケット発射予定の並び順を逆にする
1. paginateResults 関数により、取得した生データをサーバ側で扱う型形式に変換し、全てのロケット発射予定のうち指定した場所（after）から指定した数だけのデータを抽出する
1. 抽出した発射予定データと cursor、後続するデータがあるかどうかをクライアントサイドに返す

※ after = cursor は launch_date_unix に相当

### 特定の発射予定を ID で指定してフェッチする

1. リクエストを受け取ったリゾルバは Query.launch を実行する
1. context を通じて受け取ったデータソースの launchAPI の getLaunchById メソッドにより、指定された id のロケット発射予定がフェッチされる
1. 取得した生データをサーバ側で扱う型形式に変換し、結果をクライアントサイドに返す

### 特定のユーザーとしてログインする

1. リクエストを受け取ったリゾルバは Mutation.login を実行する
1. context を通じて受け取ったデータソースの userAPI の findOrCreateUser メソッドが呼び出される
1. findOrCreateUser メソッドが受け取った email を元に SQLite の findOrCreate メソッドが users テーブルからユーザーを検索し、見つかったユーザーを返す。見つからなかった場合新規作成される
1. email アドレスを base64 でエンコードしたものを token としてクライアントサイドに返す

### ユーザーがログインしている場合に宇宙旅行を予約する

1. リクエストを受け取ったリゾルバは Mutation.bookTrips を実行する
1. context を通じて受け取ったデータソースの userAPI の bookTrips メソッドが呼び出される
1. bookTrips メソッドはユーザーのログイン状況を確認し、引数で受け取った id の数だけ userAPI の bookTrip メソッドを呼び出す
1. SQLite の findOrCreate メソッドを使って、（既にデータがないかを確認して）userId と launchId を含む trips データを作成する。
1. bookTrips メソッドは予約できた trip の配列をリゾルバに返す
1. context を通じて受け取ったデータソースの launchAPI の getLaunchesByIds メソッドが呼び出される
1. getLaunchesByIds メソッドは渡された id の分だけ launchAPI の getLaunchById メソッドを利用して発射予定データを取得し、リゾルバに返す
1. リゾルバはクライアントに成功したかどうかとそのメッセージ、予約したロケットの発射予定を返す

### ユーザーがログインしている場合に宇宙旅行をキャンセルする

1. リクエストを受け取ったリゾルバは Mutation.cancelTrip を実行する
1. context を通じて受け取ったデータソースの userAPI の cancelTrip が呼び出される
1. cancelTrip では DB から userId と launchId を元にデータを検索し、ヒットしたものを削除する。成否をリゾルバに返す
1. リゾルバは削除できなかったらその旨をクライアントに返し、削除できたら削除した発射予定をクライアントに返す
